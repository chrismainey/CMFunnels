<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Funnel Plots for Indirectly-Standardised Ratios — funnel_plot • FunnelPlotR</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Funnel Plots for Indirectly-Standardised Ratios — funnel_plot" />
<meta property="og:description" content="An implementation of funnel plots for indirectly standardised ratios, as described by Spiegelhalter (2005) &amp;lt;doi:10.1002/sim.1970&amp;gt;.
There are several parameters for the input, with the assumption that you will want smooth,
 overdispersed, funnel control limits.  Limits may be inflated for overdispersion based on the DerSimmonian Laird \(\tau^2\) additive random
effects models, originally described for meta-analysis." />
<meta property="og:image" content="https://chrismainey.github.io/FunnelPlotR/logo.png" />


<meta name="robots" content="noindex">

<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146859070-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146859070-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FunnelPlotR</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.2.9999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/funnel_plots.html">Introduction to Funnel Plots</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/chrismainey/FunnelPlotR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Funnel Plots for Indirectly-Standardised Ratios</h1>
    <small class="dont-index">Source: <a href='https://github.com/chrismainey/FunnelPlotR/blob/master/R/funnel_plot.R'><code>R/funnel_plot.R</code></a></small>
    <div class="hidden name"><code>funnel_plot.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>An implementation of funnel plots for indirectly standardised ratios, as described by Spiegelhalter (2005) &lt;doi:10.1002/sim.1970&gt;.
There are several parameters for the input, with the assumption that you will want smooth,
 overdispersed, funnel control limits.  Limits may be inflated for overdispersion based on the DerSimmonian Laird \(\tau^2\) additive random
effects models, originally described for meta-analysis.</p>
    </div>

    <pre class="usage"><span class='fu'>funnel_plot</span>(
  <span class='no'>numerator</span>,
  <span class='no'>denominator</span>,
  <span class='no'>group</span>,
  <span class='kw'>data_type</span> <span class='kw'>=</span> <span class='st'>"SR"</span>,
  <span class='kw'>label_outliers</span> <span class='kw'>=</span> <span class='fl'>99</span>,
  <span class='kw'>Poisson_limits</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>OD_adjust</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>sr_method</span> <span class='kw'>=</span> <span class='st'>"SHMI"</span>,
  <span class='kw'>winsorise_by</span> <span class='kw'>=</span> <span class='fl'>0.1</span>,
  <span class='kw'>title</span> <span class='kw'>=</span> <span class='st'>"Untitled Funnel Plot"</span>,
  <span class='kw'>multiplier</span> <span class='kw'>=</span> <span class='fl'>1</span>,
  <span class='kw'>x_label</span> <span class='kw'>=</span> <span class='st'>"Expected"</span>,
  <span class='no'>y_label</span>,
  <span class='kw'>xrange</span> <span class='kw'>=</span> <span class='st'>"auto"</span>,
  <span class='kw'>yrange</span> <span class='kw'>=</span> <span class='st'>"auto"</span>,
  <span class='kw'>return_elements</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"plot"</span>, <span class='st'>"data"</span>, <span class='st'>"limits"</span>),
  <span class='kw'>theme</span> <span class='kw'>=</span> <span class='fu'><a href='funnel_clean.html'>funnel_clean</a></span>()
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>numerator</th>
      <td><p>A vector of the numerator (observed events/counts) values.  Used as numerator of the Y-axis</p></td>
    </tr>
    <tr>
      <th>denominator</th>
      <td><p>A vector of denominator (predicted/population etc).  Used as denominator of the Y-axis and the scale of the x-axis</p></td>
    </tr>
    <tr>
      <th>group</th>
      <td><p>A vector of group names as character or factor.  Used to aggregate and group points on plots</p></td>
    </tr>
    <tr>
      <th>data_type</th>
      <td><p>A string identifying the type of data used for in the plot, the adjustment used and the reference point. One of: "SR" forindirectly standardised ratios, such SHMI, "PR" for proportions, or "RC" for ratios of counts. Default is "SR".</p></td>
    </tr>
    <tr>
      <th>label_outliers</th>
      <td><p>Add group labels to outliers on plot. Accepted values are: 95 or 99 corresponding to 95% or 99.8% quantiles of the distribution. Default=99</p></td>
    </tr>
    <tr>
      <th>Poisson_limits</th>
      <td><p>Draw exact Poisson limits, without overdispersion adjustment. (default=FALSE)</p></td>
    </tr>
    <tr>
      <th>OD_adjust</th>
      <td><p>Draw overdispersed limits using hierarchical model, assuming at group level, as described in Spiegelhalter (2012) &lt;doi:https://doi.org/10.1111/j.1467-985X.2011.01010.x&gt;.
It calculates a second variance component ' for the 'between' standard deviation (Tau2), that is added to the 'within' standard deviation (sigma) (default=TRUE)</p></td>
    </tr>
    <tr>
      <th>sr_method</th>
      <td><p>Method for adjustment when using indirectly standardised ratios (type="SR") Either "CQC" or "SHMI" (default). There are a few methods for standardisation.  "CQC"/Spiegelhalter
uses a square-root transformation and Winsorises (rescales the outer most values to a particular percentile).
SHMI, instead, uses log-transformation and doesn't Winsorise, but truncates the distribution before assessing overdisperison.
Both methods then calculate a dispersion ratio (phi) on this altered dataset.  This ratio is then used to scale the full dataset,
and the plot is drawn for the full dataset.</p></td>
    </tr>
    <tr>
      <th>winsorise_by</th>
      <td><p>Proportion of the distribution for winsorisation/truncation. Default is 10 % (0.1).  Note, this is applied in a two-sided
fashion, e.g. 10% refers to 10% at each end of the distribution (20% winsorised/truncated)</p></td>
    </tr>
    <tr>
      <th>title</th>
      <td><p>Plot title</p></td>
    </tr>
    <tr>
      <th>multiplier</th>
      <td><p>Scale relative risk and funnel by this factor. Default to 1, but 100 sometime used, e.g. in some hospital mortality ratios.</p></td>
    </tr>
    <tr>
      <th>x_label</th>
      <td><p>Title for the funnel plot x-axis.  Usually expected deaths, readmissions, incidents etc.</p></td>
    </tr>
    <tr>
      <th>y_label</th>
      <td><p>Title for the funnel plot y-axis.  Usually a standardised ratio.</p></td>
    </tr>
    <tr>
      <th>xrange</th>
      <td><p>Manually specify the y-axis min and max, in form c(min, max), e.g. c(0, 200). Default, "auto", allows function to estimate range.</p></td>
    </tr>
    <tr>
      <th>yrange</th>
      <td><p>Manually specify the y-axis min and max, in form c(min, max), e.g. c(0.7, 1.3). Default, "auto", allows function to estimate range.</p></td>
    </tr>
    <tr>
      <th>return_elements</th>
      <td><p>a vector of elements to return, options include "plot" for ggplot2 object, "data" for data after processing, and "limits" for control
limit lookup table used in the plot. Default is all three objects.</p></td>
    </tr>
    <tr>
      <th>theme</th>
      <td><p>a ggplot theme function.  This can be a canned theme such as theme_bw(), a theme() with arguments, or your own custom theme function. Default is new funnel_clean(), but funnel_classic() is original format.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A list containing [1] the funnel plot as a ggplot2 object, [2] the base table for the plot, [3] the limits table.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Outliers are marked based on the grouping, and controlled by `label_outliers` .
   Overdispersion can be factored in based on the methods in Spiegelhalter et al (2012) &lt;doi:https://doi.org/10.1111/j.1467-985X.2011.01010.x&gt;, set `OD_adjust` to FALSE to suppress this. <br />
   To use Poisson limits set `Poisson_limits=TRUE`. This uses 95<!-- % &amp; 99.8% limits limits. \cr -->
   It deliberately avoids red-amber-green colouring, but you could extract this from the ggplot object and change manually if you like.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p>Statistical methods for healthcare regulation: rating, screening and surveillance. Spiegelhalter et al (2012) &lt;doi:https://doi.org/10.1111/j.1467-985X.2011.01010.x&gt; <br />
Funnel plots for comparing institutional performance. Spiegelhalter (2005) &lt;doi:10.1002/sim.1970&gt; <br />
Handling over-dispersion of performance indicators. Spiegelhalter (2005) &lt;doi:10.1136/qshc.2005.013755&gt;</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'>#' # We will use the 'medpar' dataset from the 'COUNT' package.</span>
<span class='co'># Little reformatting needed</span>

<span class='fu'><a href='https://rdrr.io/r/base/library.html'>library</a></span>(<span class='no'>COUNT</span>)</div><div class='output co'>#&gt; <span class='message'>Loading required package: msme</span></div><div class='output co'>#&gt; <span class='message'>Loading required package: MASS</span></div><div class='output co'>#&gt; <span class='message'></span>
#&gt; <span class='message'>Attaching package: ‘MASS’</span></div><div class='output co'>#&gt; <span class='message'>The following object is masked from ‘package:dplyr’:</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    select</span></div><div class='output co'>#&gt; <span class='message'>Loading required package: lattice</span></div><div class='output co'>#&gt; <span class='message'>Loading required package: sandwich</span></div><div class='input'><span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span>(<span class='no'>medpar</span>)
<span class='no'>medpar</span>$<span class='no'>provnum</span><span class='kw'>&lt;-</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span>(<span class='no'>medpar</span>$<span class='no'>provnum</span>)
<span class='no'>medpar</span>$<span class='no'>los</span><span class='kw'>&lt;-</span><span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span>(<span class='no'>medpar</span>$<span class='no'>los</span>)

<span class='no'>mod</span><span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span>(<span class='no'>los</span> ~ <span class='no'>hmo</span> + <span class='no'>died</span> + <span class='no'>age80</span> + <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span>(<span class='no'>type</span>)
      , <span class='kw'>family</span><span class='kw'>=</span><span class='st'>"poisson"</span>, <span class='kw'>data</span><span class='kw'>=</span><span class='no'>medpar</span>)
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='no'>mod</span>)</div><div class='output co'>#&gt; 
#&gt; Call:
#&gt; glm(formula = los ~ hmo + died + age80 + factor(type), family = "poisson", 
#&gt;     data = medpar)
#&gt; 
#&gt; Deviance Residuals: 
#&gt;     Min       1Q   Median       3Q      Max  
#&gt; -5.7309  -1.9554  -0.5529   0.9717  14.5487  
#&gt; 
#&gt; Coefficients:
#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    
#&gt; (Intercept)    2.26875    0.01246 182.011  &lt; 2e-16 ***
#&gt; hmo           -0.07637    0.02393  -3.192  0.00142 ** 
#&gt; died          -0.24574    0.01826 -13.458  &lt; 2e-16 ***
#&gt; age80         -0.02141    0.02050  -1.045  0.29617    
#&gt; factor(type)2  0.24921    0.02099  11.871  &lt; 2e-16 ***
#&gt; factor(type)3  0.74869    0.02627  28.496  &lt; 2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
#&gt; 
#&gt; (Dispersion parameter for poisson family taken to be 1)
#&gt; 
#&gt;     Null deviance: 8901.1  on 1494  degrees of freedom
#&gt; Residual deviance: 7977.7  on 1489  degrees of freedom
#&gt; AIC: 13705
#&gt; 
#&gt; Number of Fisher Scoring iterations: 5
#&gt; </div><div class='input'>
<span class='co'># Get predicted values for building ratio</span>
<span class='no'>medpar</span>$<span class='no'>prds</span><span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span>(<span class='no'>mod</span>, <span class='kw'>type</span><span class='kw'>=</span><span class='st'>"response"</span>)

<span class='co'># Draw plot, returning just the plot object</span>
<span class='no'>fp</span><span class='kw'>&lt;-</span><span class='fu'>funnel_plot</span>(<span class='kw'>denominator</span><span class='kw'>=</span><span class='no'>medpar</span>$<span class='no'>prds</span>, <span class='kw'>numerator</span><span class='kw'>=</span><span class='no'>medpar</span>$<span class='no'>los</span>,
<span class='kw'>group</span> <span class='kw'>=</span> <span class='no'>medpar</span>$<span class='no'>provnum</span>, <span class='kw'>return_elements</span><span class='kw'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"plot"</span>))
<span class='no'>fp</span></div><div class='output co'>#&gt; $plot</div><div class='img'><img src='funnel_plot-1.png' alt='' width='700' height='433' /></div><div class='output co'>#&gt; </div><div class='input'>

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by <a href='http://www.mainard.co.uk'>Chris Mainey</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


